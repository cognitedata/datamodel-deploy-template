name: Publish data model
on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "models/**"

jobs:
  generate-matrix:
    uses: "./.github/workflows/generate-matrix.yaml"
    with:
      deploy_folders: "models/"
      trigger_deploy_all_folders: "models/config.yaml"

  deploy:
    needs: generate-matrix
    name: Deploy Cognite data models
    runs-on: ubuntu-latest
    strategy:
      matrix:
        model: ${{ fromJson(needs.generate-matrix.outputs.folders) }}
        # Add environments to deploy to.
        # Each environment should have a corresponding GitHub environment with secrets.
        environment:
          - test

    environment: ${{ matrix.environment }}

    steps:
      - name: Check out code
        if: ${{ contains(needs.generate-matrix.outputs.deploy_folders, matrix.model) }}
        uses: actions/checkout@v3

      - name: Deploy data model
        if: ${{ contains(needs.generate-matrix.outputs.deploy_folders, matrix.model) }}
        env:
          TENANT_ID: ${{ vars.TENANT_ID }}
          CDF_CLUSTER: ${{ vars.CDF_CLUSTER }}
          CDF_PROJECT: ${{ vars.CDF_PROJECT }}
          CLIENT_ID: ${{ vars.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
        run:
           python build_scripts/replace_vars.py "${{ matrix.model }}"
           python build_scripts/deploy_model.py "${{ matrix.model }}"

name: Publish data models
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  generate-matrix:
    uses: "./.github/workflows/generate-matrix.yaml"
    with:
      deploy_folders: "MovieDM"
      trigger_deploy_all_folders: "common"

  deploy:
    needs: generate-matrix
    name: Deploy Cognite data models
    runs-on: ubuntu-latest
    strategy:
      matrix:
        datamodel: ${{ fromJson(needs.generate-matrix.outputs.folders) }}
        # Add environments to deploy to.
        # Each environment should have a corresponding github environment with secrets.
        environment:
          - test

    environment: ${{ matrix.environment }}

    steps:
      - name: Check out code
        #if: ${{ contains(needs.generate-matrix.outputs.deploy_folders, matrix.datamodel) }}
        uses: actions/checkout@v3

      - name: Setup Node ðŸ”§
        #if: ${{ contains(needs.generate-matrix.outputs.deploy_folders, matrix.datamodel) }}
        uses: actions/setup-node@v3

      - name: Install ðŸ”§
        #if: ${{ contains(needs.generate-matrix.outputs.deploy_folders, matrix.datamodel) }}
        run: npm install --global @cognite/cdf-cli
      
      # add more data models like this:
      - name: Deploy data model
        #if: ${{ contains(needs.generate-matrix.outputs.deploy_folders, matrix.datamodel) }}
        uses: "./.github/actions/datamodel-action"
        with:
          clientId: $COGNITE_CLIENT_ID
          clientSecret: $COGNITE_CLIENT_SECRET
          cluster: $COGNITE_CLUSTER
          tenantId: $COGNITE_TENANT_ID
          modelName: $matrix.datamodel # external_id
          modelFile: ./datamodels/${{ matrix.datamodel }}/datamodel.graphql
          space: "Movie"
          project: $COGNITE_PROJECT
          version:  7
